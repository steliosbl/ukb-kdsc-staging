---
title: "UKB KDSC GP Biomarkers"
format: html
---

# 4. GP-Recorded Biomarkers for eGFR and ACR
We extract eGFR, ACR, creatinine, cystatin C, urine albumin, and urine
creatinine from linked primary care (GP) records.

We read from data/common/Primary Care/gp_clinical_records.csv (either
generated by R01-extract.rmd or copied from the parent repo).

## 0. Setup
```{r}
source(knitr::purl("R00-parameters.rmd", quiet = TRUE, output = tempfile()))

library(tidyverse)
library(data.table)
library(dtplyr)
library(arrow)
library(lubridate)

source("lib/egfr.R")
```

## 1. Data Sources
```{r}
dt_cohort <- read_parquet("data/cohort.parquet") %>% as.data.table()
dt_codelist <- fread("codelists/read_codes_renal.csv") %>%
  filter(include == 1) %>%
  select(read_code, term_description, type)

gp_clinical <- fread("../data/common/Primary Care/gp_clinical_records.csv",
  na.strings = c("", "NA")
)
```

## 2. Match Renal Codes
```{r}
dt_matches_all <- gp_clinical %>%
  lazy_dt() %>%
  inner_join(dt_codelist, by = "read_code") %>%
  inner_join(
    dt_cohort %>% lazy_dt() %>% select(eid, censor_date_start, censor_date_end),
    by = "eid"
  ) %>%
  filter(!is.na(event_date)) %>%
  filter(
    event_date >= (censor_date_start - 10 * 365.25) &
      event_date <= censor_date_end
  ) %>%
  as.data.table()

cat(sprintf("Matched %d GP records to renal codelists\n", nrow(dt_matches_all)))
dt_matches_all[, .N, by = type] %>% print()

# Save code-level summary for downstream reporting (S01-results)
gp_code_summary <- dt_matches_all %>%
  lazy_dt() %>%
  group_by(type, read_code, term_description) %>%
  summarise(
    n_records = n(),
    n_participants = n_distinct(eid),
    .groups = "drop"
  ) %>%
  arrange(type, desc(n_records)) %>%
  as.data.table()

out_file <- "data/gp_code_summary.parquet"
write_parquet(gp_code_summary, out_file)
upload_to_dx(out_file, "kdsc_staging/gp_code_summary.parquet")
```

## 3. Curate Numerical Values

### 3.1 Serum Creatinine
Values in umol/L. Small values (<15) may be mg/dL and are converted.
```{r}
dt_creat <- dt_matches_all %>%
  lazy_dt() %>%
  filter(type == "creat" & value_number == 1) %>%
  mutate(value = as.numeric(value)) %>%
  filter(!is.na(value) & value > 0 & value <= 2000) %>%
  mutate(value = if_else(value < 15, value * 88.4, value)) %>%
  as.data.table()
```

### 3.2 eGFR (GP-reported)
```{r}
dt_egfr_gp <- dt_matches_all %>%
  lazy_dt() %>%
  filter(type == "egfr" & value_number == 1) %>%
  mutate(value = as.numeric(value)) %>%
  filter(!is.na(value) & value > 2 & value <= 200) %>%
  as.data.table()
```

### 3.3 Urine Albumin
```{r}
dt_uriamac <- dt_matches_all %>%
  lazy_dt() %>%
  filter(type == "uriamac" & value_number == 1) %>%
  mutate(value = as.numeric(value)) %>%
  filter(!is.na(value) & value > 0) %>%
  as.data.table()
```

### 3.4 Urine Creatinine
Values in mmol/L. Values 40-400 assumed to be mg/dL and converted.
```{r}
dt_uriacc <- dt_matches_all %>%
  lazy_dt() %>%
  filter(type == "uriacc" & value_number == 1) %>%
  mutate(value = as.numeric(value)) %>%
  filter(!is.na(value) & value > 0) %>%
  mutate(
    unit_class = case_when(
      value < 40 ~ "mmol/L",
      value >= 40 & value <= 400 ~ "mg/dL",
      TRUE ~ "outlier"
    )
  ) %>%
  mutate(value = if_else(unit_class == "mg/dL", value / 11.312, value)) %>%
  filter(unit_class != "outlier") %>%
  mutate(value = value * 1000) %>%
  select(-unit_class) %>%
  as.data.table()
```

### 3.5 ACR (GP-reported)
```{r}
dt_acr_gp <- dt_matches_all %>%
  lazy_dt() %>%
  filter(type == "acr" & value_number == 1) %>%
  mutate(value = as.numeric(value)) %>%
  filter(!is.na(value) & value > 0) %>%
  as.data.table()
```

## 4. Combine and Deduplicate
```{r}
extracted <- rbind(
  dt_creat[, .(eid, date = event_date, type, value)],
  dt_egfr_gp[, .(eid, date = event_date, type, value)],
  dt_uriamac[, .(eid, date = event_date, type, value)],
  dt_uriacc[, .(eid, date = event_date, type, value)],
  dt_acr_gp[, .(eid, date = event_date, type, value)]
)

extracted <- extracted %>%
  lazy_dt() %>%
  group_by(eid, type, date) %>%
  filter(value == max(value)) %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  as.data.table()
```

## 5. Unit Conversion
```{r}
extracted[type == "creat", value := value / 88.4]
extracted[type == "uriacc", value := value / 1000]
```

## 6. Compute eGFR from Creatinine
```{r}
dt_cyst_gp <- extracted[type == "cyst"]
dt_creat_conv <- extracted[type == "creat"]

if (nrow(dt_cyst_gp) > 0) {
  dt_creat_matched <- dt_creat_conv %>%
    lazy_dt() %>%
    rename(date_creat = date, creat = value) %>%
    left_join(
      dt_cyst_gp %>% lazy_dt() %>% rename(date_cyst = date, cyst = value),
      by = "eid", relationship = "many-to-many"
    ) %>%
    mutate(diff = abs(as.integer(date_creat - date_cyst))) %>%
    mutate(cyst = ifelse(diff <= 90, cyst, NA_real_)) %>%
    group_by(eid, date_creat) %>%
    arrange(diff) %>%
    slice_head(n = 1) %>%
    ungroup() %>%
    select(eid, date = date_creat, creat, cyst)
} else {
  dt_creat_matched <- dt_creat_conv %>%
    lazy_dt() %>%
    rename(creat = value) %>%
    mutate(cyst = NA_real_) %>%
    select(eid, date, creat, cyst)
}

dt_egfr_computed <- dt_creat_matched %>%
  inner_join(
    dt_cohort %>% lazy_dt() %>% select(eid, date_of_birth, sex),
    by = "eid"
  ) %>%
  mutate(age = as.double(date - as.IDate(date_of_birth)) / 365.25) %>%
  mutate(
    egfr = case_when(
      !is.na(cyst) ~ egfr_creat_cys_2021(creat, cyst, age, sex),
      TRUE ~ egfr_creat_2021(creat, age, sex)
    )
  ) %>%
  mutate(type = "egfr") %>%
  select(eid, date, value = egfr, type) %>%
  as.data.table()

extracted <- rbind(
  extracted[type != "egfr"],
  dt_egfr_computed
)
```

## 7. Compute ACR from Components
ACR (mg/g) = (urine albumin (mg/L) / urine creatinine (mmol/L)) * 8.84
```{r}
dt_uriacc_conv <- extracted[type == "uriacc"]
dt_uriamac_conv <- extracted[type == "uriamac"]

if (nrow(dt_uriacc_conv) > 0 && nrow(dt_uriamac_conv) > 0) {
  dt_acr_computed <- dt_uriacc_conv %>%
    lazy_dt() %>%
    rename(date_uriacc = date, uriacc = value) %>%
    left_join(
      dt_uriamac_conv %>% lazy_dt() %>% rename(date_uriamac = date, uriamac = value),
      by = "eid", relationship = "many-to-many"
    ) %>%
    mutate(diff = abs(as.integer(date_uriacc - date_uriamac))) %>%
    mutate(uriamac = ifelse(diff <= 90, uriamac, NA_real_)) %>%
    group_by(eid, date_uriacc) %>%
    arrange(diff) %>%
    slice_head(n = 1) %>%
    ungroup() %>%
    select(eid, date = date_uriacc, uriacc, uriamac) %>%
    mutate(acr = (uriamac / uriacc) * 8.84) %>%
    mutate(type = "acr") %>%
    select(eid, date, value = acr, type) %>%
    filter(!is.na(value)) %>%
    as.data.table()

  extracted <- rbind(
    extracted[type != "acr"],
    dt_acr_computed
  )
}
```

## 8. Build Output
```{r}
dt_gp_long <- extracted %>%
  lazy_dt() %>%
  filter(type %in% c("egfr", "acr")) %>%
  select(eid, date, type, value) %>%
  mutate(source = "gp") %>%
  as.data.table()

cat(sprintf("GP eGFR measurements: %d\n", dt_gp_long[type == "egfr", .N]))
cat(sprintf("GP ACR measurements: %d\n", dt_gp_long[type == "acr", .N]))
```

## 9. Save
```{r}
out_file <- "data/biomarkers_gp.parquet"
write_parquet(dt_gp_long, out_file)
upload_to_dx(out_file, "kdsc_staging/biomarkers_gp.parquet")
```
