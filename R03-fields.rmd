---
title: "UKB KDSC Biomarker Fields"
format: html
---

# 3. UKB-Assayed Biomarkers for eGFR and ACR
We extract creatinine, cystatin C, urine albumin, and urine creatinine from
the pre-curated biomarkers table, then compute eGFR (CKD-EPI 2021) and ACR.

We read from data/common/Biomarkers/biomarkers.csv (either generated by
R01-extract.rmd or copied from the parent repo).

## 0. Setup
```{r}
source(knitr::purl("R00-parameters.rmd", quiet = TRUE, output = tempfile()))

library(tidyverse)
library(data.table)
library(dtplyr)
library(arrow)

source("lib/egfr.R")
```

## 1. Data Sources
```{r}
dt_cohort <- read_parquet("data/cohort.parquet") %>% as.data.table()
dt_visits <- read_parquet("data/visits.parquet") %>% as.data.table()

dt_biomarkers <- fread("../data/common/Biomarkers/biomarkers.csv") %>%
  lazy_dt() %>%
  select(eid, visit_index, creat, cyst, uriacc, uriamac) %>%
  as.data.table()
```

## 2. Unit Conversion
Convert SI units to conventional units:
 - Creatinine: umol/L -> mg/dL (/ 88.4)
 - Urine creatinine: umol/L -> mmol/L (/ 1000)
 - Urine albumin: mg/L (no conversion)
 - Cystatin C: mg/L (no conversion)

```{r}
dt_biomarkers[, creat_mgdl := creat / 88.4]
dt_biomarkers[, uriacc_mmol := uriacc / 1000]
```

## 3. Compute eGFR
Using CKD-EPI 2021 equations.
```{r}
dt_egfr <- dt_biomarkers %>%
  lazy_dt() %>%
  inner_join(dt_visits, by = c("eid", "visit_index")) %>%
  inner_join(
    dt_cohort %>% lazy_dt() %>% select(eid, date_of_birth, sex),
    by = "eid"
  ) %>%
  filter(!is.na(creat)) %>%
  mutate(
    age = as.double(assessment_date - date_of_birth) / 365.25,
    egfr = case_when(
      !is.na(cyst) ~ egfr_creat_cys_2021(creat_mgdl, cyst, age, sex),
      TRUE ~ egfr_creat_2021(creat_mgdl, age, sex)
    )
  ) %>%
  as.data.table()

dt_biomarkers[dt_egfr, on = .(eid, visit_index), egfr := i.egfr]
```

## 4. Compute ACR
ACR (mg/g) = (urine albumin (mg/L) / urine creatinine (mmol/L)) * 8.84

We apply the same range clamping as the parent repo (R02c-covariates.rmd):
 - urine creatinine: [500, 50000] Âµmol/L (= [0.5, 50] mmol/L)
 - urine albumin: [0, 5000] mg/L
```{r}
dt_biomarkers[, uriacc_clamped := pmin(pmax(uriacc, 500), 50000) / 1000]
dt_biomarkers[, uriamac_clamped := pmin(pmax(uriamac, 0), 5000)]
dt_biomarkers[, acr := (uriamac_clamped / uriacc_clamped) * 8.84]
# Only compute ACR where both components are measured
dt_biomarkers[is.na(uriamac) | is.na(uriacc), acr := NA_real_]
```

## 5. Build Long-Format Output
We include derived biomarkers (eGFR, ACR) and their component measurements
(creatinine, cystatin C, urine albumin, urine creatinine) in conventional units
so downstream notebooks can use them without re-reading the raw biomarkers file.
```{r}
dt_ukb_long <- dt_biomarkers %>%
  lazy_dt() %>%
  inner_join(dt_visits, by = c("eid", "visit_index")) %>%
  select(eid, date = assessment_date,
         egfr, acr,
         creat = creat_mgdl, cyst, uriamac, uriacc = uriacc_mmol) %>%
  pivot_longer(
    cols = c(egfr, acr, creat, cyst, uriamac, uriacc),
    names_to = "type",
    values_to = "value"
  ) %>%
  filter(!is.na(value)) %>%
  mutate(source = "ukb") %>%
  as.data.table()

for (t in c("egfr", "acr", "creat", "cyst", "uriamac", "uriacc")) {
  cat(sprintf("UKB %s measurements: %d\n", t, dt_ukb_long[type == t, .N]))
}
```

## 6. Save
```{r}
out_file <- "data/biomarkers_ukb.parquet"
write_parquet(dt_ukb_long, out_file)
upload_to_dx(out_file, "kdsc_staging/biomarkers_ukb.parquet")
```
